<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Normandy Trading House — Monitor</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,600&family=Cormorant+SC:wght@400;500;600;700&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --black:    #000000;
  --bg:       #080808;
  --card:     #0e0e0e;
  --card2:    #111111;
  --border:   rgba(180,150,80,0.18);
  --border2:  rgba(180,150,80,0.32);
  --gold:     #C9A84C;
  --gold-dim: rgba(201,168,76,0.10);
  --white:    #f0ece2;
  --white-60: rgba(240,236,226,0.60);
  --white-30: rgba(240,236,226,0.30);
  --white-10: rgba(240,236,226,0.07);
  --green:    #3dba6f;
  --green-dim:rgba(61,186,111,0.12);
  --red:      #d94f4f;
  --red-dim:  rgba(217,79,79,0.12);
  --serif:   'Cormorant Garamond', Georgia, serif;
  --sc:      'Cormorant SC', Georgia, serif;
  --mono:    'DM Mono', monospace;
  --sans:    'DM Sans', sans-serif;
  --ease:    cubic-bezier(0.16,1,0.3,1);
}

*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
html { scroll-behavior:smooth; }

body {
  background: var(--black);
  color: var(--white);
  font-family: var(--sans);
  font-size: 14px;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
  min-height: 100vh;
  padding: 32px 24px 60px;
}

.frame {
  max-width: 1340px;
  margin: 0 auto;
  border: 1px solid var(--border);
  border-radius: 16px;
  background: var(--bg);
  overflow: hidden;
  box-shadow: 0 0 0 1px rgba(201,168,76,0.05), 0 40px 120px rgba(0,0,0,0.85);
}

/* TOPBAR */
.topbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 26px 44px;
  border-bottom: 1px solid var(--border);
  background: #070707;
}
.brand { display:flex; align-items:center; gap:20px; }
.heraldry img {
  width: 56px; height: 64px;
  filter: drop-shadow(0 2px 14px rgba(201,168,76,0.22));
}
.brand-name { font-family:var(--sc); font-size:22px; font-weight:600; letter-spacing:0.06em; color:var(--gold); line-height:1.15; }
.brand-sub  { font-family:var(--sans); font-size:11px; font-weight:300; letter-spacing:0.14em; color:var(--white-30); margin-top:3px; text-transform:uppercase; }
.topbar-right { display:flex; flex-direction:column; align-items:flex-end; gap:4px; }
.topbar-private { font-family:var(--sans); font-size:12px; font-weight:300; color:var(--white-30); letter-spacing:0.06em; }
.clock { font-family:var(--mono); font-size:12px; font-weight:300; color:var(--white-30); letter-spacing:0.06em; }

/* Live update indicator */
.live-badge {
  display: flex; align-items: center; gap: 6px;
  font-family: var(--mono); font-size: 9px; font-weight: 300;
  color: var(--white-30); letter-spacing: 0.1em;
}
.live-dot {
  width: 6px; height: 6px; border-radius: 50%;
  background: var(--green);
  box-shadow: 0 0 6px var(--green);
  transition: background 0.3s, box-shadow 0.3s;
}
.live-dot.offline { background: var(--red); box-shadow: 0 0 6px var(--red); }
.live-dot.updating { background: var(--gold); box-shadow: 0 0 6px var(--gold); }

/* Flash animation when data updates */
@keyframes dataFlash {
  0%   { opacity:1; }
  20%  { opacity:0.5; }
  100% { opacity:1; }
}
.flashing { animation: dataFlash 0.4s ease; }

/* BODY */
.body { display:grid; grid-template-columns:1fr 356px; }
.main    { padding:48px; border-right:1px solid var(--border); }
.sidebar { padding:36px 30px; background:#070707; }

/* OVERVIEW */
.overview-label { font-family:var(--sans); font-size:11px; font-weight:300; letter-spacing:0.16em; text-transform:uppercase; color:var(--white-30); margin-bottom:16px; }
.overview-title { font-family:var(--serif); font-size:clamp(30px,3.2vw,46px); font-weight:300; letter-spacing:-0.01em; line-height:1.15; color:var(--white); margin-bottom:14px; }
.overview-desc  { font-family:var(--sans); font-size:13px; font-weight:300; color:var(--white-30); margin-bottom:5px; }
.overview-tags  { font-family:var(--sans); font-size:13px; font-weight:400; color:var(--gold); margin-bottom:36px; }

/* EQUITY */
.equity-header { display:flex; align-items:center; gap:14px; margin-bottom:14px; }
.equity-label  { font-family:var(--serif); font-size:15px; font-weight:400; color:var(--white-60); white-space:nowrap; }
.divider-line  { flex:1; height:1px; background:var(--border); }
.equity-source { font-family:var(--serif); font-style:italic; font-size:13px; color:var(--white-30); white-space:nowrap; }

.equity-strip { display:grid; grid-template-columns:repeat(4,1fr); gap:2px; margin-bottom:48px; }
.eq-card { background:var(--card2); border:1px solid var(--border); padding:18px 20px 16px; transition:border-color .2s var(--ease); }
.eq-card:hover { border-color:var(--border2); }
.eq-label { font-family:var(--sans); font-size:11px; font-weight:500; color:var(--gold); margin-bottom:8px; letter-spacing:.04em; }
.eq-val   { font-family:var(--mono); font-size:24px; font-weight:500; letter-spacing:-0.02em; line-height:1; margin-bottom:5px; }
.eq-val.pos { color:var(--green); }
.eq-val.neg { color:var(--red); }
.eq-val.wht { color:var(--white); }
.eq-sub { font-family:var(--sans); font-size:11px; font-weight:300; color:var(--white-30); }

/* SECTIONS */
.section-heading { font-family:var(--serif); font-size:22px; font-weight:400; color:var(--gold); margin-bottom:3px; letter-spacing:.01em; }
.section-sub     { font-family:var(--sans); font-size:12px; font-weight:300; color:var(--white-30); margin-bottom:20px; }

/* ASSET TABLE */
.asset-table { width:100%; border-collapse:collapse; margin-bottom:44px; }
.asset-table th {
  text-align:left; padding:10px 14px;
  font-family:var(--sans); font-size:10px; font-weight:500;
  letter-spacing:.16em; text-transform:uppercase;
  color:var(--white-30); border-bottom:1px solid var(--border); white-space:nowrap;
}
.asset-table td {
  padding:13px 14px;
  font-family:var(--mono); font-size:12px; font-weight:300;
  color:var(--white-60); border-bottom:1px solid rgba(180,150,80,.06); white-space:nowrap;
}
.asset-table tr:last-child td { border-bottom:none; }
.asset-table tr:hover td { background:var(--white-10); }
.td-pos { color:var(--green) !important; font-weight:500 !important; }
.td-neg { color:var(--red) !important; }
.td-wht { color:var(--white) !important; }

.pos-badge { font-family:var(--mono); font-size:9px; font-weight:500; letter-spacing:.14em; padding:4px 10px; border-radius:2px; text-transform:uppercase; }
.pb-long  { background:var(--green-dim); color:var(--green); border:1px solid rgba(61,186,111,.25); }
.pb-short { background:var(--red-dim);   color:var(--red);   border:1px solid rgba(217,79,79,.25); }
.pb-flat  { background:var(--white-10);  color:var(--white-30); border:1px solid var(--border); }
.mode-bull { color:var(--green) !important; }
.mode-bear { color:var(--red) !important; }
.mode-chop { color:var(--white-30) !important; }

/* TRADE LOG */
.tradelog-head { display:flex; align-items:baseline; justify-content:space-between; margin-bottom:3px; }
.tradelog-note { font-family:var(--sans); font-size:11px; font-weight:300; color:var(--white-30); }
.table-scroll  { overflow-x:auto; max-height:280px; overflow-y:auto; border:1px solid var(--border); }
.table-scroll::-webkit-scrollbar { width:3px; height:3px; }
.table-scroll::-webkit-scrollbar-track { background:transparent; }
.table-scroll::-webkit-scrollbar-thumb { background:var(--border2); border-radius:2px; }

.log-table { width:100%; border-collapse:collapse; }
.log-table thead { position:sticky; top:0; background:#0d0d0d; z-index:2; }
.log-table th { text-align:left; padding:10px 14px; font-family:var(--sans); font-size:9px; font-weight:500; letter-spacing:.16em; text-transform:uppercase; color:var(--white-30); border-bottom:1px solid var(--border); white-space:nowrap; }
.log-table td { padding:11px 14px; font-family:var(--mono); font-size:11px; font-weight:300; color:var(--white-60); border-bottom:1px solid rgba(180,150,80,.05); white-space:nowrap; }
.log-table tr:last-child td { border-bottom:none; }
.log-table tr:hover td { background:var(--white-10); }
.lt-long  { color:var(--green) !important; font-weight:500 !important; }
.lt-short { color:var(--red) !important;   font-weight:500 !important; }
.lt-pos   { color:var(--green) !important; }
.lt-neg   { color:var(--red) !important; }
.lt-dim   { color:var(--white-30) !important; }

/* DISCLAIMER */
.disclaimer { margin-top:32px; padding:18px 20px; border:1px solid var(--border); background:var(--white-10); }
.disclaimer p { font-family:var(--sans); font-size:11px; font-weight:300; color:var(--white-30); line-height:1.7; }

/* SIDEBAR */
.sb-section { margin-bottom:32px; }
.sb-heading { font-family:var(--serif); font-size:20px; font-weight:400; color:var(--gold); margin-bottom:3px; }
.sb-desc    { font-family:var(--sans); font-size:11px; font-weight:300; color:var(--white-30); margin-bottom:18px; letter-spacing:.04em; }
.engine-status { display:flex; align-items:center; gap:12px; margin-bottom:18px; padding:14px 16px; background:var(--white-10); border:1px solid var(--border); }
.status-dot { width:9px; height:9px; border-radius:50%; background:var(--green); box-shadow:0 0 8px var(--green); flex-shrink:0; animation:pulse 2.4s ease-in-out infinite; }
.status-dot.offline { background:var(--red); box-shadow:0 0 8px var(--red); animation:none; }
@keyframes pulse { 0%,100%{opacity:1;}50%{opacity:0.25;} }
.engine-label { font-family:var(--sans); font-size:13px; font-weight:500; color:var(--white); }
.engine-sub   { font-family:var(--sans); font-size:11px; font-weight:300; color:var(--green); margin-top:1px; }
.info-row { display:flex; justify-content:space-between; align-items:baseline; padding:10px 0; border-bottom:1px solid var(--border); }
.info-row:last-child { border-bottom:none; }
.info-key { font-family:var(--sans); font-size:12px; font-weight:500; color:var(--white-60); }
.info-val { font-family:var(--mono); font-size:11px; font-weight:300; color:var(--white-30); text-align:right; }
.info-val.live { color:var(--green); }
.sb-divider { height:1px; background:var(--border); margin:24px 0; }
.sb-metric-grid { display:grid; grid-template-columns:1fr 1fr; gap:2px; }
.sb-metric { background:var(--card2); border:1px solid var(--border); padding:14px; }
.sb-metric-label { font-family:var(--sans); font-size:10px; font-weight:400; letter-spacing:.12em; text-transform:uppercase; color:var(--white-30); margin-bottom:7px; }
.sb-metric-val { font-family:var(--mono); font-size:18px; font-weight:500; letter-spacing:-0.02em; line-height:1; }
.sb-metric-val.pos { color:var(--green); }
.sb-metric-val.wht { color:var(--white); }
.health-row { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border); }
.health-row:last-child { border-bottom:none; }
.health-key { font-family:var(--sans); font-size:12px; font-weight:400; color:var(--white-60); }
.health-val { font-family:var(--mono); font-size:13px; font-weight:400; }
.health-val.pos { color:var(--green); }
.health-val.neg { color:var(--red); }
.health-val.wht { color:var(--white); }
.sb-tradelog { border:1px solid var(--border); overflow:hidden; }
.sb-tradelog-head { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); background:var(--white-10); }
.sb-tradelog-title { font-family:var(--serif); font-size:16px; font-weight:400; color:var(--gold); }
.sb-tradelog-note  { font-family:var(--mono); font-size:9px; color:var(--white-30); letter-spacing:.08em; }
.sb-table { width:100%; border-collapse:collapse; }
.sb-table th { text-align:left; padding:9px 12px; font-family:var(--sans); font-size:9px; font-weight:500; letter-spacing:.14em; text-transform:uppercase; color:var(--white-30); border-bottom:1px solid var(--border); white-space:nowrap; }
.sb-table td { padding:10px 12px; font-family:var(--mono); font-size:11px; font-weight:300; color:var(--white-60); border-bottom:1px solid rgba(180,150,80,.05); white-space:nowrap; }
.sb-table tr:last-child td { border-bottom:none; }
.sb-table tr:hover td { background:var(--white-10); }

/* Balance strip */
.balance-strip {
  display: flex; align-items: center; gap: 24px;
  padding: 14px 20px; margin-bottom: 20px;
  background: var(--white-10); border: 1px solid var(--border);
  font-family: var(--mono); font-size: 12px;
}
.bal-label { color: var(--white-30); font-size: 10px; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 3px; font-family: var(--sans); }
.bal-val   { color: var(--white); font-size: 18px; font-weight: 500; }
.bal-sep   { width: 1px; height: 36px; background: var(--border); }

@keyframes up { from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);} }
.anim { animation:up 0.55s var(--ease) both; }

@media (max-width:1100px) {
  .body { grid-template-columns:1fr; }
  .main { border-right:none; border-bottom:1px solid var(--border); }
  .equity-strip { grid-template-columns:1fr 1fr; }
}
@media (max-width:680px) {
  body { padding:10px 10px 48px; }
  .topbar { flex-direction:column; gap:16px; align-items:flex-start; padding:22px; }
  .main { padding:28px 20px; }
  .equity-strip { grid-template-columns:1fr 1fr; }
}
</style>
</head>
<body>
<div class="frame">

  <!-- TOPBAR -->
  <header class="topbar anim" style="animation-delay:0s">
    <div class="brand">
      <div class="heraldry">
        <img src="crest.png" alt="Normandy Trading House Crest">
      </div>
      <div class="brand-text">
        <div class="brand-name">Normandy Trading House</div>
        <div class="brand-sub">Deterministic Engine V1.4 &nbsp;·&nbsp; Algo Monitor</div>
      </div>
    </div>
    <div class="topbar-right">
      <div class="topbar-private">Private dashboard &nbsp;·&nbsp; Not for public distribution</div>
      <div class="clock" id="clock">--:--:-- UTC</div>
      <div class="live-badge">
        <div class="live-dot" id="live-dot"></div>
        <span id="live-status">connecting...</span>
      </div>
    </div>
  </header>

  <!-- BODY -->
  <div class="body">

    <!-- ═══ MAIN ═══ -->
    <main class="main">

      <div class="anim" style="animation-delay:0.06s">
        <div class="overview-label">Overview</div>
        <div class="overview-title">Normandy Trading House —<br>Proprietary Desk</div>
        <div class="overview-desc">Internal monitoring and execution telemetry</div>
        <div class="overview-tags">Multi-asset &nbsp;·&nbsp; Equities &amp; Derivatives &amp; FX</div>
      </div>

      <!-- Virtual Balance Strip -->
      <div class="anim" style="animation-delay:0.08s">
        <div class="balance-strip">
          <div>
            <div class="bal-label">Virtual Balance</div>
            <div class="bal-val" id="bal-value">£10,000.00</div>
          </div>
          <div class="bal-sep"></div>
          <div>
            <div class="bal-label">Daily P&amp;L</div>
            <div class="bal-val" id="bal-daily-pnl">—</div>
          </div>
          <div class="bal-sep"></div>
          <div>
            <div class="bal-label">Daily P&amp;L %</div>
            <div class="bal-val" id="bal-daily-pct">—</div>
          </div>
          <div class="bal-sep"></div>
          <div>
            <div class="bal-label">Open Positions</div>
            <div class="bal-val" id="bal-open-pos">—</div>
          </div>
        </div>
      </div>

      <!-- Equity Strip -->
      <div class="anim" style="animation-delay:0.10s">
        <div class="equity-header">
          <span class="equity-label">Session Performance</span>
          <span class="divider-line"></span>
          <span class="equity-source" id="eq-last-update">TradeAnalytics · live</span>
        </div>
        <div class="equity-strip">
          <div class="eq-card">
            <div class="eq-label">Session Return</div>
            <div class="eq-val wht" id="eq-total-return">—</div>
            <div class="eq-sub" id="eq-total-return-sub">waiting for trades</div>
          </div>
          <div class="eq-card">
            <div class="eq-label">Profit Factor</div>
            <div class="eq-val wht" id="eq-profit-factor">—</div>
            <div class="eq-sub">Robust ≥ 1.5 threshold</div>
          </div>
          <div class="eq-card">
            <div class="eq-label">Win Rate</div>
            <div class="eq-val wht" id="eq-win-rate">—</div>
            <div class="eq-sub" id="eq-win-rate-sub">—</div>
          </div>
          <div class="eq-card">
            <div class="eq-label">Max Drawdown</div>
            <div class="eq-val wht" id="eq-max-dd">—</div>
            <div class="eq-sub" id="eq-max-dd-sub">—</div>
          </div>
        </div>
      </div>

      <!-- Asset Positions -->
      <div class="anim" style="animation-delay:0.14s; margin-top:44px">
        <div class="section-heading">Asset Positions</div>
        <div class="section-sub">Live instrument exposure — six active strategies</div>
        <table class="asset-table">
          <thead>
            <tr>
              <th>Instrument</th><th>Market</th><th>Position</th>
              <th>Session P&amp;L</th><th>Trades</th><th>Win %</th><th>PF</th><th>Mode</th>
            </tr>
          </thead>
          <tbody id="asset-table-body">
            <tr id="asset-table-placeholder"><td colspan="8" style="text-align:center;color:var(--white-30);padding:28px;font-family:var(--mono);font-size:11px;">Awaiting engine data — start dashboard_server.py</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Trade Log -->
      <div class="anim" style="animation-delay:0.18s">
        <div class="tradelog-head">
          <div class="section-heading">Trade Log</div>
          <div class="tradelog-note" id="tradelog-note">latest executions · all assets</div>
        </div>
        <div class="section-sub">Chronological record of executions — read only</div>
        <div class="table-scroll">
          <table class="log-table">
            <thead>
              <tr>
                <th>#</th><th>Asset</th><th>Side</th>
                <th>Exit Time</th><th>Exit Price</th>
                <th>P&amp;L £</th><th>P&amp;L %</th><th>Cumulative</th><th>Reason</th>
              </tr>
            </thead>
            <tbody id="tradelog-body">
              <tr><td colspan="9" style="text-align:center;color:var(--white-30);padding:24px;font-family:var(--mono);font-size:11px;">Waiting for first execution...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="disclaimer anim" style="animation-delay:0.22s; margin-top:32px">
        <p>Normandy Trading House operates this interface for internal monitoring purposes only. This dashboard does not constitute investment advice, solicitation, or any warranty of future performance. All content is for the operator's use exclusively. Past performance is not indicative of future results.</p>
      </div>

    </main>

    <!-- ═══ SIDEBAR ═══ -->
    <aside class="sidebar">

      <div class="sb-section anim" style="animation-delay:0.08s">
        <div class="sb-heading">Execution Status</div>
        <div class="sb-desc">Strategy heartbeat and system health</div>
        <div class="engine-status">
          <div class="status-dot" id="engine-dot"></div>
          <div>
            <div class="engine-label">Strategy Engine</div>
            <div class="engine-sub" id="engine-sub">Live · Deterministic V1.4</div>
          </div>
        </div>
        <div>
          <div class="info-row"><span class="info-key">Last updated</span><span class="info-val live" id="heartbeat">--:--:--</span></div>
          <div class="info-row"><span class="info-key">Data source</span><span class="info-val">execution_log.csv</span></div>
          <div class="info-row"><span class="info-key">System health</span><span class="info-val live" id="sys-health">Connecting</span></div>
          <div class="info-row"><span class="info-key">Instruments</span><span class="info-val">6 active</span></div>
          <div class="info-row"><span class="info-key">Open positions</span><span class="info-val live" id="sb-open-pos">—</span></div>
        </div>
      </div>

      <div class="sb-divider"></div>

      <div class="sb-section anim" style="animation-delay:0.12s">
        <div class="sb-heading">Session Metrics</div>
        <div class="sb-desc">Live quality indicators</div>
        <div class="sb-metric-grid">
          <div class="sb-metric"><div class="sb-metric-label">Total Trades</div><div class="sb-metric-val wht" id="m-total-trades">—</div></div>
          <div class="sb-metric"><div class="sb-metric-label">Win Rate</div><div class="sb-metric-val wht" id="m-win-rate">—</div></div>
          <div class="sb-metric"><div class="sb-metric-label">Long WR</div><div class="sb-metric-val pos" id="m-long-wr">—</div></div>
          <div class="sb-metric"><div class="sb-metric-label">Short WR</div><div class="sb-metric-val wht" id="m-short-wr">—</div></div>
          <div class="sb-metric"><div class="sb-metric-label">Profit Factor</div><div class="sb-metric-val wht" id="m-pf">—</div></div>
          <div class="sb-metric"><div class="sb-metric-label">Avg P&amp;L</div><div class="sb-metric-val wht" id="m-avg-pnl">—</div></div>
        </div>
      </div>

      <div class="sb-divider"></div>

      <div class="sb-section anim" style="animation-delay:0.16s">
        <div class="sb-heading">System Health</div>
        <div class="sb-desc">Live monitoring indicators</div>
        <div>
          <div class="health-row"><span class="health-key">Rolling 20T Expectancy</span><span class="health-val wht" id="h-expectancy">—</span></div>
          <div class="health-row"><span class="health-key">Volatility σ</span><span class="health-val wht" id="h-volatility">—</span></div>
          <div class="health-row"><span class="health-key">Recovery Factor</span><span class="health-val wht" id="h-recovery">—</span></div>
          <div class="health-row"><span class="health-key">Long / Short</span><span class="health-val wht" id="h-long-short">—</span></div>
          <div class="health-row"><span class="health-key">Total Trades</span><span class="health-val wht" id="h-total-trades">—</span></div>
          <div class="health-row"><span class="health-key">Session P&amp;L</span><span class="health-val wht" id="h-session-pnl">—</span></div>
        </div>
      </div>

      <div class="sb-divider"></div>

      <div class="sb-section anim" style="animation-delay:0.20s">
        <div class="sb-tradelog">
          <div class="sb-tradelog-head">
            <span class="sb-tradelog-title">Recent Trades</span>
            <span class="sb-tradelog-note">latest · all assets</span>
          </div>
          <table class="sb-table">
            <thead><tr><th>Asset</th><th>Side</th><th>P&amp;L £</th><th>Cum%</th></tr></thead>
            <tbody id="sb-tradelog-body">
              <tr><td colspan="4" style="text-align:center;color:var(--white-30);padding:16px;font-size:10px;">No trades yet</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </aside>
  </div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════
// NORMANDY LIVE DASHBOARD — Polling Engine
//
// Mode detection:
//   • Served from localhost:5050  → hits /api/status (live, 5s)
//   • Opened from GitHub Pages    → reads ./status.json (5s)
//   • Opened as local file        → reads ./status.json (5s)
// ═══════════════════════════════════════════════════════════════

const IS_LOCAL_SERVER = window.location.port === '5050' && window.location.hostname === 'localhost';
const API_URL         = IS_LOCAL_SERVER ? '/api/status' : './status.json';
const POLL_INTERVAL   = 5000;

const ASSET_NAMES = {
  xau:     'XAU/USD', sp500: 'S&P 500', ftse100: 'FTSE 100',
  gbpchf:  'GBP/CHF', xrp:   'XRP/USD', ukoil:   'UK Oil'
};

// ── Clock ──────────────────────────────────────────────────────
function pad(n){ return String(n).padStart(2,'0'); }
function tickClock(){
  const n = new Date();
  document.getElementById('clock').textContent =
    `${pad(n.getUTCHours())}:${pad(n.getUTCMinutes())}:${pad(n.getUTCSeconds())} UTC`;
}
tickClock(); setInterval(tickClock, 1000);

// ── Helpers ────────────────────────────────────────────────────
function fmt(v, dp=2){ return typeof v==='number' ? v.toFixed(dp) : '—'; }
function fmtGBP(v){
  if(typeof v!=='number') return '—';
  const s = Math.abs(v).toLocaleString('en-GB',{minimumFractionDigits:2,maximumFractionDigits:2});
  return (v>=0?'+£':'-£') + s;
}
function fmtPct(v, dp=2){
  if(typeof v!=='number') return '—';
  return (v>=0?'\u25b2':'\u25bc') + Math.abs(v).toFixed(dp) + '%';
}
function setClass(el, v, posClass='td-pos', negClass='td-neg', neutClass='td-wht'){
  el.classList.remove(posClass, negClass, neutClass);
  if(typeof v==='number') el.classList.add(v>0?posClass:v<0?negClass:neutClass);
  else el.classList.add(neutClass);
}
function flash(el){
  if(!el) return;
  el.classList.remove('flashing');
  void el.offsetWidth;
  el.classList.add('flashing');
}
function setText(id, text, flashIt=false){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = text;
  if(flashIt) flash(el);
}

// ── Main render ────────────────────────────────────────────────
let lastTradeCount = 0;

function render(data){
  // If data is empty object (engine not started yet / status.json not populated)
  const hasData = data && (data.balance || data.analytics || data.per_asset);
  if(!hasData){
    setOffline('No engine data yet');
    document.getElementById('sys-health').textContent = 'Engine not started';
    return;
  }

  const hasNewTrades = (data.analytics?.total_trades || 0) > lastTradeCount;
  lastTradeCount = data.analytics?.total_trades || 0;

  renderBalance(data.balance, data.open_positions);
  renderEquityStrip(data.analytics);
  renderAssetTable(data.per_asset, data.open_positions);
  renderTradeLog(data.recent_trades);
  renderSidebar(data.analytics, data.health);
  renderSidebarTradeLog(data.recent_trades);

  // Update timestamp
  const now = new Date();
  setText('heartbeat', `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`);
  setText('eq-last-update', 'TradeAnalytics · updated ' + now.toLocaleTimeString('en-GB'));
}

function renderBalance(bal, openPos){
  if(!bal) return;
  const balEl = document.getElementById('bal-value');
  const pnlEl = document.getElementById('bal-daily-pnl');
  const pctEl = document.getElementById('bal-daily-pct');
  const posEl = document.getElementById('bal-open-pos');
  if(balEl) { balEl.textContent = '£' + bal.balance.toLocaleString('en-GB',{minimumFractionDigits:2}); flash(balEl); }
  if(pnlEl) {
    const v = bal.daily_pnl;
    pnlEl.textContent = fmtGBP(v);
    setClass(pnlEl, v, 'td-pos','td-neg','td-wht');
    flash(pnlEl);
  }
  if(pctEl) {
    const v = bal.daily_pnl_pct;
    pctEl.textContent = fmtPct(v, 3);
    setClass(pctEl, v, 'td-pos','td-neg','td-wht');
  }
  if(posEl) {
    const n = Object.keys(openPos||{}).length;
    posEl.textContent = n===0 ? 'None' : `${n} open`;
    setClass(posEl, n>0?1:0, 'td-pos','td-neg','td-wht');
  }
}

function renderEquityStrip(a){
  if(!a || !a.total_trades) return;
  const retEl  = document.getElementById('eq-total-return');
  const retSub = document.getElementById('eq-total-return-sub');
  const pfEl   = document.getElementById('eq-profit-factor');
  const wrEl   = document.getElementById('eq-win-rate');
  const wrSub  = document.getElementById('eq-win-rate-sub');
  const ddEl   = document.getElementById('eq-max-dd');
  const ddSub  = document.getElementById('eq-max-dd-sub');
  if(retEl){
    const v = a.total_pnl_pct||0;
    retEl.textContent = fmtPct(v, 3);
    setClass(retEl, v);
    if(retSub) retSub.textContent = `${a.total_trades} trades · £${(a.total_pnl||0).toFixed(2)}`;
    flash(retEl);
  }
  if(pfEl){
    pfEl.textContent = fmt(a.profit_factor);
    setClass(pfEl, a.profit_factor>1.5?1:a.profit_factor<1?-1:0);
  }
  if(wrEl){
    wrEl.textContent = fmt(a.win_rate)+'%';
    if(wrSub) wrSub.textContent = `Expectancy ▲${fmt(a.avg_pnl_pts||0,2)} pts`;
  }
  if(ddEl){
    const v = a.max_dd_pct||0;
    ddEl.textContent = v===0?'—':'▼'+Math.abs(v).toFixed(2)+'%';
    setClass(ddEl, v*-1);
    if(ddSub) ddSub.textContent = a.total_trades ? `${a.total_trades} total trades` : '—';
  }
}

function badgeHTML(pos){
  if(pos==='LONG')  return '<span class="pos-badge pb-long">Long</span>';
  if(pos==='SHORT') return '<span class="pos-badge pb-short">Short</span>';
  return '<span class="pos-badge pb-flat">Flat</span>';
}
function modeClass(m){
  if(!m) return '';
  const u = m.toUpperCase();
  if(u==='BULL') return 'mode-bull';
  if(u==='BEAR') return 'mode-bear';
  return 'mode-chop';
}

function renderAssetTable(assets, openPos){
  const tbody = document.getElementById('asset-table-body');
  if(!tbody || !assets || !assets.length) return;
  tbody.innerHTML = assets.map(a => {
    const perf = a.perf_pct||0;
    const perfTxt = perf===0 ? '—' : fmtPct(perf,3);
    const perfCls = perf>0?'td-pos':perf<0?'td-neg':'';
    const winCls  = a.win_pct>40?'td-pos':'';
    const pfCls   = a.pf>1.5?'td-pos':a.pf<1&&a.pf>0?'td-neg':'';
    const mc      = modeClass(a.mode);
    const modeDisplay = a.mode || '—';
    return `<tr>
      <td class="td-wht">${a.name}</td>
      <td>${a.market}</td>
      <td>${badgeHTML(a.pos)}</td>
      <td class="${perfCls}">${perfTxt}</td>
      <td>${a.trades||0}</td>
      <td class="${winCls}">${a.trades?a.win_pct+'%':'—'}</td>
      <td class="${pfCls}">${a.trades?fmt(a.pf):'—'}</td>
      <td class="${mc}">${modeDisplay}</td>
    </tr>`;
  }).join('');
}

function renderTradeLog(trades){
  const tbody = document.getElementById('tradelog-body');
  if(!tbody) return;
  if(!trades || !trades.length){
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--white-30);padding:24px;font-family:var(--mono);font-size:11px;">No completed trades this session</td></tr>';
    return;
  }
  const rows = [...trades].reverse().slice(0,20);
  tbody.innerHTML = rows.map((t,i) => {
    const sideCls = t.side==='LONG'?'lt-long':'lt-short';
    const pnlCls  = t.pnl>=0?'lt-pos':'lt-neg';
    const cumCls  = t.cum_pct>=0?'lt-pos':'lt-neg';
    const pnlTxt  = t.pnl>=0?`+£${t.pnl.toFixed(2)}`:`-£${Math.abs(t.pnl).toFixed(2)}`;
    const pnlPct  = fmtPct(t.pnl_pct,3);
    const cumPct  = fmtPct(t.cum_pct,3);
    return `<tr>
      <td class="lt-dim">${String(rows.length-i).padStart(3,'0')}</td>
      <td>${t.symbol}</td>
      <td class="${sideCls}">${t.side}</td>
      <td>${t.exit_time}</td>
      <td>£${typeof t.exit_price==='number'?t.exit_price.toLocaleString('en-GB',{minimumFractionDigits:2}):'—'}</td>
      <td class="${pnlCls}">${pnlTxt}</td>
      <td class="${pnlCls}">${pnlPct}</td>
      <td class="${cumCls}">${cumPct}</td>
      <td style="color:var(--white-30);font-size:10px;">${t.reason||'signal'}</td>
    </tr>`;
  }).join('');
}

function renderSidebar(a, health){
  if(a){
    setText('m-total-trades', a.total_trades||'—', true);
    const wrEl = document.getElementById('m-win-rate');
    if(wrEl){ wrEl.textContent = a.total_trades ? fmt(a.win_rate)+'%' : '—'; setClass(wrEl, a.win_rate>40?1:a.win_rate>30?0:-1,'pos','neg','wht'); }
    const pfEl = document.getElementById('m-pf');
    if(pfEl){ pfEl.textContent = a.total_trades ? fmt(a.profit_factor) : '—'; setClass(pfEl, a.profit_factor>1.5?1:a.profit_factor<1?-1:0,'pos','neg','wht'); }
    setText('m-avg-pnl', a.total_trades ? `£${fmt(a.avg_pnl_pts,2)}` : '—');
    setText('h-session-pnl', a.total_pnl ? fmtGBP(a.total_pnl) : '—');
    setText('h-total-trades', a.total_trades||'—');
  }
  if(health){
    const expEl = document.getElementById('h-expectancy');
    if(expEl){ expEl.textContent = typeof health.rolling_expectancy_20==='number' ? fmtPct(health.rolling_expectancy_20,4) : '—'; setClass(expEl, health.rolling_expectancy_20||0, 'pos','neg','wht'); }
    setText('h-volatility', typeof health.volatility_pct==='number' ? fmt(health.volatility_pct,4)+'%' : '—');
    const recEl = document.getElementById('h-recovery');
    if(recEl){ recEl.textContent = health.recovery_factor ? `×${fmt(health.recovery_factor)}` : '—'; setClass(recEl, health.recovery_factor>3?1:0,'pos','neg','wht'); }
    setText('h-long-short', `${health.total_long||0} / ${health.total_short||0}`);
    setText('m-long-wr', health.long_wr!=null ? health.long_wr+'%' : '—');
    setText('m-short-wr', health.short_wr!=null ? health.short_wr+'%' : '—');
  }

  // Open positions in sidebar
  const openEl = document.getElementById('sb-open-pos');
  if(openEl){
    const posEl2 = document.getElementById('bal-open-pos');
    if(posEl2) openEl.textContent = posEl2.textContent;
  }
}

function renderSidebarTradeLog(trades){
  const tbody = document.getElementById('sb-tradelog-body');
  if(!tbody) return;
  if(!trades || !trades.length){
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--white-30);padding:16px;font-size:10px;">No trades yet</td></tr>';
    return;
  }
  const rows = [...trades].reverse().slice(0,7);
  tbody.innerHTML = rows.map(t => {
    const sideCls = t.side==='LONG'?'lt-long':'lt-short';
    const pnlCls  = t.pnl>=0?'lt-pos':'lt-neg';
    const cumCls  = t.cum_pct>=0?'lt-pos':'lt-neg';
    const pnlTxt  = t.pnl>=0?`+£${t.pnl.toFixed(2)}`:`-£${Math.abs(t.pnl).toFixed(2)}`;
    return `<tr>
      <td>${ASSET_NAMES[t.symbol.toLowerCase().split('/')[0]]||t.symbol}</td>
      <td class="${sideCls}">${t.side}</td>
      <td class="${pnlCls}">${pnlTxt}</td>
      <td class="${cumCls}">${fmtPct(t.cum_pct,3)}</td>
    </tr>`;
  }).join('');
}

// ── Connection status ──────────────────────────────────────────
function setOnline(){
  const dot = document.getElementById('live-dot');
  const status = document.getElementById('live-status');
  const engineDot = document.getElementById('engine-dot');
  if(dot){ dot.className='live-dot'; }
  if(status){ status.textContent='live · 5s refresh'; }
  if(engineDot){ engineDot.className='status-dot'; }
  setText('sys-health','Nominal');
}
function setOffline(err){
  const dot = document.getElementById('live-dot');
  const status = document.getElementById('live-status');
  const engineDot = document.getElementById('engine-dot');
  if(dot){ dot.className='live-dot offline'; }
  if(status){ status.textContent='server offline'; }
  if(engineDot){ engineDot.className='status-dot offline'; }
  setText('sys-health','No connection');
}
function setUpdating(){
  const dot = document.getElementById('live-dot');
  if(dot) dot.className='live-dot updating';
}

// ── Poll ───────────────────────────────────────────────────────
async function poll(){
  setUpdating();
  try {
    const res = await fetch(API_URL, { cache: 'no-store' });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    setOnline();
    render(data);
  } catch(e) {
    setOffline(e.message);
  }
}

poll();
setInterval(poll, POLL_INTERVAL);
</script>
</body>
</html>
